<nav class="fr-sidemenu fr-sidemenu--sticky-full-height fr-mb-0-5v" role="navigation" aria-labelledby="fr-sidemenu-title">
    <div class="fr-sidemenu__inner fr-pt-12v">
        <button class="fr-sidemenu__btn" hidden aria-controls="fr-sidemenu-wrapper" aria-expanded="false">
            Dans cette rubrique
        </button>
        <div class="fr-collapse" id="fr-sidemenu-wrapper">
            <div class="fr-sidemenu__title" id="fr-sidemenu-title">
                {{ sidemenuTitle }}
            </div>
            <ul class="fr-sidemenu__list">
                {% for link in navLinks %}
                    {% set parentIdx = loop.index0 %}
                    {% set level2Id = 'sidemenu-2-' ~ parentIdx %}
                    <li class="fr-sidemenu__item">
                        {% if not link.children | length %}
                        <a class="fr-sidemenu__link" href={{ link.url | locale_url(lang) }} {% if link.url == page.url %} aria-current="page"{% endif %}>
                            {{ link.title }}
                        </a>
                        {% else %}
                        <button class="fr-sidemenu__btn" aria-expanded="false" aria-controls="{{ level2Id }}" data-url="{{ link.url | locale_url(lang) }}">
                            {{ link.title }}
                        </button>
                        <div class="fr-collapse" id="{{ level2Id }}">
                            <ul class="fr-sidemenu__list">
                            {% for sublink in link.children %}
                                {% set level3Id = 'sidemenu-3-' ~ parentIdx ~ '-' ~ loop.index0 %}
                                <li class="fr-sidemenu__item">
                                {% if not sublink.children | length %}
                                    <a class="fr-sidemenu__link"
                                    href="{{ sublink.url | locale_url(lang) or sublink.externalUrl }}"
                                    {% if sublink.externalUrl %} target="_blank" rel="noopener"{% endif %}
                                    {% if sublink.url == page.url %} aria-current="page"{% endif %}>
                                    {{ sublink.title }}
                                    </a>
                                {% else %}
                                    <button class="fr-sidemenu__btn" aria-expanded="false" aria-controls="{{ level3Id }}" data-url="{{ sublink.url | locale_url(lang) or sublink.externalUrl }}">
                                    {{ sublink.title }}
                                    </button>
                                    <div class="fr-collapse" id="{{ level3Id }}">
                                    <ul class="fr-sidemenu__list">
                                        {% for subsublink in sublink.children %}
                                            <li class="fr-sidemenu__item">
                                                <a class="fr-sidemenu__link"
                                                href="{{ subsublink.url | locale_url(lang) or subsublink.externalUrl }}"
                                                {% if subsublink.externalUrl %} target="_blank" rel="noopener"{% endif %}
                                                {% if subsublink.url == page.url %} aria-current="page"{% endif %}>
                                                {{ subsublink.title }}
                                                </a>
                                            </li>
                                        {% endfor %}
                                    </ul>
                                    </div>
                                {% endif %}
                                </li>
                            {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                    </li>
                {% endfor %}
            </ul>
        </div>
    </div>
</nav>

<script>
    (() => {
        const normalize = (p) => {
            if (!p) return "";
            p = String(p).trim();
            try { p = new URL(p, location.origin).pathname; } catch(e) {}

            if (p.length > 1 && p.endsWith("/")) p = p.slice(0, -1);
            if (p && !p.startsWith("/")) p = "/" + p;
            return p;
        };

        const hrefPath = (el) => normalize(el.getAttribute("href") || el.href || "");

        const currentPath = normalize(location.pathname);
        const sidemenuActive = normalize("{{ eleventyNavigation.sidemenuActive or '' }}");

        const links = [...document.querySelectorAll(".fr-sidemenu__link")];
        const buttons = [...document.querySelectorAll(".fr-sidemenu__btn[data-url]")];

        const activeParentBtn = buttons.find(btn => 
            normalize(btn.dataset.url) === currentPath
        );

        let activeLink = null;

        if (sidemenuActive) {
            activeLink = links.find(a => hrefPath(a) === sidemenuActive);
        }

        if (!activeLink) {
            activeLink = links.find(a => hrefPath(a) === currentPath);
        }

        if (activeParentBtn) {
            activeLink = null;
        }

        function expandParents(element) {
            let parent = element.closest(".fr-collapse");
            while (parent) {
                if (parent.id === "fr-sidemenu-wrapper") break;

                const toggle = parent.previousElementSibling;
                if (toggle?.classList.contains("fr-sidemenu__btn")) {
                    toggle.setAttribute("aria-expanded", "true");
                    parent.classList.add("fr-collapse--expanded");
                }
                parent = parent.parentElement.closest(".fr-collapse");
            }
        }

        document.querySelectorAll(".fr-sidemenu__link[aria-current]")
            .forEach(l => l.removeAttribute("aria-current"));

        if (activeLink) {
            activeLink.setAttribute("aria-current", "page");
            expandParents(activeLink);
        }

        else if (activeParentBtn) {
            activeParentBtn.setAttribute("aria-expanded", "true");

            const panel = activeParentBtn.nextElementSibling;
            if (panel?.classList.contains("fr-collapse")) {
                panel.classList.add("fr-collapse--expanded");
            }

            activeParentBtn.classList.add("fr-sidemenu__btn--current");

            expandParents(activeParentBtn);
        }

        links.forEach((link) => {
            link.addEventListener("click", (e) => {
                document
                    .querySelectorAll(".fr-sidemenu__link[aria-current]")
                    .forEach((l) => l.removeAttribute("aria-current"));

                e.currentTarget.setAttribute("aria-current", "page");
            });
        });

    })();
</script>